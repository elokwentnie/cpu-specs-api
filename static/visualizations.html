<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Compute Specs DB - Visualizations</title>
    <link rel="icon" type="image/png" href="/static/images/server-logo.png">
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <link rel="stylesheet" href="/static/css/common.css">
    <link rel="stylesheet" href="/static/css/visualizations.css">
</head>
<body>
    <div class="header">
        <h1>ðŸ“Š Compute Specs DB Visualizations</h1>
        <p>Interactive charts and analysis of CPU performance metrics</p>
    </div>

    <div class="nav">
        <a href="/">ðŸ“‹ Table View</a>
        <a href="/visualizations">ðŸ“Š Visualizations</a>
        <a href="/docs">ðŸ“š API Docs</a>
    </div>

    <div class="container">
        <div class="stats" id="stats">
            <div class="stat-card">
                <div class="stat-value" id="totalCpus">-</div>
                <div class="stat-label">Total CPUs</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="avgTdp">-</div>
                <div class="stat-label">Avg TDP (W)</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="avgCores">-</div>
                <div class="stat-label">Avg Cores</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="avgFreq">-</div>
                <div class="stat-label">Avg Frequency (GHz)</div>
            </div>
        </div>

        <div class="controls">
            <div class="controls-grid">
                <div class="control-group">
                    <label for="xAxis">X-Axis Parameter</label>
                    <select id="xAxis">
                        <option value="tdp_watts">TDP (W)</option>
                        <option value="max_turbo_frequency_ghz">Max Turbo Frequency (GHz)</option>
                        <option value="cores">Cores</option>
                        <option value="threads">Threads</option>
                        <option value="l3_cache_mb">L3 Cache (MB)</option>
                        <option value="max_memory_tb">Max Memory (TB)</option>
                        <option value="launch_year">Launch Year</option>
                    </select>
                </div>

                <div class="control-group">
                    <label for="yAxis">Y-Axis Parameter</label>
                    <select id="yAxis">
                        <option value="max_turbo_frequency_ghz">Max Turbo Frequency (GHz)</option>
                        <option value="tdp_watts">TDP (W)</option>
                        <option value="cores">Cores</option>
                        <option value="threads">Threads</option>
                        <option value="l3_cache_mb">L3 Cache (MB)</option>
                        <option value="max_memory_tb">Max Memory (TB)</option>
                        <option value="launch_year">Launch Year</option>
                    </select>
                </div>

                <div class="control-group">
                    <label for="chartType">Chart Type</label>
                    <select id="chartType">
                        <option value="scatter">Scatter Plot</option>
                        <option value="bar">Bar Chart</option>
                        <option value="box">Box Plot</option>
                    </select>
                </div>

            </div>

        </div>

        <div class="filters-section">
            <h3>ðŸ“Š Filters</h3>
            <div class="filter-group">
                <label>Filter by Family:</label>
                <div class="filter-actions">
                    <button class="filter-action-btn" onclick="selectAllFilters('family')">Select All</button>
                </div>
                <div class="filter-checkbox-group" id="familyFilters">
                    <div class="loading">Loading families...</div>
                </div>
            </div>
            <div class="filter-group">
                <label>Filter by Codename:</label>
                <div class="filter-actions">
                    <button class="filter-action-btn" onclick="selectAllFilters('codename')">Select All</button>
                </div>
                <div class="filter-checkbox-group" id="codenameFilters">
                    <div class="loading">Loading codenames...</div>
                </div>
            </div>
        </div>

        <div class="chart-container">
            <div class="chart-header">
                <div class="chart-title" id="chartTitle">Loading data...</div>
                <button id="downloadChart" class="download-btn hidden">
                    <span>ðŸ’¾</span>
                    <span>Download Chart</span>
                </button>
            </div>
            <div id="barLimitGroup" class="bar-limit-group hidden">
                <label for="barLimit">Number of CPUs to Display:</label>
                <input type="number" id="barLimit" min="5" max="100" value="25">
            </div>
            <div id="chart">
                <div class="loading">Loading chart data...</div>
            </div>
        </div>

        <div class="chart-container">
            <div class="chart-title text-center">CPU Comparison Tool</div>
            <div class="comparison-controls">
                <div class="comparison-selectors">
                    <div class="comparison-selector">
                        <label for="cpu1Select">CPU 1</label>
                        <select id="cpu1Select">
                            <option value="">Select CPU...</option>
                        </select>
                    </div>
                    <div class="comparison-selector">
                        <label for="cpu2Select">CPU 2</label>
                        <select id="cpu2Select">
                            <option value="">Select CPU...</option>
                        </select>
                    </div>
                </div>
                <div class="compare-btn-container">
                    <button id="compareButton" class="compare-btn" disabled>
                        Compare CPUs
                    </button>
                </div>
            </div>
            <div id="comparisonResult" class="hidden">
                <div class="comparison-download-row">
                    <button id="downloadComparison" class="download-btn">
                        <span>ðŸ’¾</span>
                        <span>Download Comparison</span>
                    </button>
                </div>
                <div class="comparison-table-container">
                    <table class="comparison-table" id="comparisonTable">
                        <thead>
                            <tr>
                                <th>Specification</th>
                                <th id="cpu1NameHeader">CPU 1</th>
                                <th id="cpu2NameHeader">CPU 2</th>
                                <th>Difference</th>
                            </tr>
                        </thead>
                        <tbody id="comparisonBody">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        <footer class="data-footer">
            <p class="data-footer-title">Data Validation</p>
            <p>All specifications have been manually validated against official manufacturer sources:</p>
            <div class="data-footer-sources">
                <a href="https://www.intel.com/content/www/us/en/products/overview.html" target="_blank" rel="noopener">Intel</a>
                <a href="https://www.amd.com/en/products/specifications/processors.html" target="_blank" rel="noopener">AMD</a>
                <a href="https://www.techpowerup.com/" target="_blank" rel="noopener">TechPowerUp</a>
                <a href="https://www.cpubenchmark.net/" target="_blank" rel="noopener">PassMark</a>
            </div>
            <p>Found an error? <a href="https://github.com/elokwentnie/compute-specs-db/issues/new?template=report-data-error.yml" target="_blank" rel="noopener">Report it on GitHub</a> | <a href="https://github.com/elokwentnie/compute-specs-db/issues/new?template=new-cpu-request.yml" target="_blank" rel="noopener">Suggest a new CPU</a></p>
        </footer>
    </div>

    <footer class="site-footer">
        <div class="site-footer-inner">
            <div class="site-footer-top">
                <span class="site-footer-brand">Compute Specs DB</span>
                <nav class="site-footer-links">
                    <a href="/">Data Table</a>
                    <a href="/visualizations">Visualizations</a>
                    <a href="/docs" target="_blank">API Docs</a>
                    <a href="https://github.com/elokwentnie/compute-specs-db" target="_blank" rel="noopener">GitHub</a>
                    <a href="https://github.com/elokwentnie/compute-specs-db/issues/new/choose" target="_blank" rel="noopener">Contribute</a>
                </nav>
            </div>
            <hr class="site-footer-divider">
            <div class="site-footer-bottom">
                <span class="site-footer-disclaimer">Intel, Xeon, and Core are trademarks of Intel Corporation. AMD, EPYC, Ryzen, and Threadripper are trademarks of Advanced Micro Devices, Inc. All other trademarks are the property of their respective owners. Data is provided "as-is" for informational purposes only, without warranty of any kind.</span>
                <span>&copy; 2026 Compute Specs DB &middot; Open Source</span>
            </div>
        </div>
    </footer>

    <script>
        let allCpus = [];
        let filteredCpus = [];
        let activeFamilies = new Set();
        let activeCodenames = new Set();

        // Fetch all CPU data
        async function loadData() {
            try {
                const response = await fetch('/api/cpus?limit=1000');
                allCpus = await response.json();
                filteredCpus = allCpus;
                
                updateStats();
                setupFilters();
                updateChart();
                populateComparisonDropdowns();
            } catch (error) {
                document.getElementById('chart').innerHTML = 
                    '<div class="error">Error loading data: ' + error.message + '</div>';
            }
        }

        // Update statistics
        function updateStats() {
            const validCpus = filteredCpus.filter(cpu => cpu.tdp_watts && cpu.cores && cpu.max_turbo_frequency_ghz);
            
            document.getElementById('totalCpus').textContent = filteredCpus.length;
            
            const avgTdp = validCpus.length > 0 
                ? (validCpus.reduce((sum, c) => sum + (c.tdp_watts || 0), 0) / validCpus.length).toFixed(1)
                : '-';
            document.getElementById('avgTdp').textContent = avgTdp;
            
            const avgCores = validCpus.length > 0
                ? (validCpus.reduce((sum, c) => sum + (c.cores || 0), 0) / validCpus.length).toFixed(1)
                : '-';
            document.getElementById('avgCores').textContent = avgCores;
            
            const avgFreq = validCpus.length > 0
                ? (validCpus.reduce((sum, c) => sum + (c.max_turbo_frequency_ghz || 0), 0) / validCpus.length).toFixed(2)
                : '-';
            document.getElementById('avgFreq').textContent = avgFreq;
        }

        // Setup filter checkboxes
        function setupFilters() {
            const families = [...new Set(allCpus.map(cpu => cpu.family).filter(f => f))].sort();
            const codenames = [...new Set(allCpus.map(cpu => cpu.codename).filter(c => c))].sort();

            const familyContainer = document.getElementById('familyFilters');
            familyContainer.innerHTML = '';
            families.forEach(family => {
                const item = document.createElement('div');
                item.className = 'filter-checkbox-item';
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.id = `family-${family.replace(/\s+/g, '-')}`;
                checkbox.checked = true;
                checkbox.dataset.type = 'family';
                checkbox.dataset.value = family;
                checkbox.addEventListener('change', (e) => {
                    toggleFilter('family', family, e.target.checked);
                });
                const label = document.createElement('label');
                label.htmlFor = checkbox.id;
                label.textContent = family;
                item.appendChild(checkbox);
                item.appendChild(label);
                familyContainer.appendChild(item);
                activeFamilies.add(family);
            });

            const codenameContainer = document.getElementById('codenameFilters');
            codenameContainer.innerHTML = '';
            codenames.forEach(codename => {
                const item = document.createElement('div');
                item.className = 'filter-checkbox-item';
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.id = `codename-${codename.replace(/\s+/g, '-')}`;
                checkbox.checked = true;
                checkbox.dataset.type = 'codename';
                checkbox.dataset.value = codename;
                checkbox.addEventListener('change', (e) => {
                    toggleFilter('codename', codename, e.target.checked);
                });
                const label = document.createElement('label');
                label.htmlFor = checkbox.id;
                label.textContent = codename;
                item.appendChild(checkbox);
                item.appendChild(label);
                codenameContainer.appendChild(item);
                activeCodenames.add(codename);
            });
        }

        // Toggle filter
        function toggleFilter(type, value, checked) {
            if (type === 'family') {
                if (checked) {
                    activeFamilies.add(value);
                } else {
                    activeFamilies.delete(value);
                }
            } else {
                if (checked) {
                    activeCodenames.add(value);
                } else {
                    activeCodenames.delete(value);
                }
            }
            applyFilters();
        }

        // Select all filters of a type
        window.selectAllFilters = function(type) {
            const container = type === 'family' 
                ? document.getElementById('familyFilters')
                : document.getElementById('codenameFilters');
            
            if (!container) return;
            
            const checkboxes = container.querySelectorAll('input[type="checkbox"]');
            checkboxes.forEach(checkbox => {
                checkbox.checked = true;
                const value = checkbox.dataset.value;
                if (type === 'family') {
                    activeFamilies.add(value);
                } else {
                    activeCodenames.add(value);
                }
            });
            applyFilters();
        };

        // Select none filters of a type
        window.selectNoneFilters = function(type) {
            const container = type === 'family' 
                ? document.getElementById('familyFilters')
                : document.getElementById('codenameFilters');
            
            if (!container) return;
            
            const checkboxes = container.querySelectorAll('input[type="checkbox"]');
            checkboxes.forEach(checkbox => {
                checkbox.checked = false;
                const value = checkbox.dataset.value;
                if (type === 'family') {
                    activeFamilies.delete(value);
                } else {
                    activeCodenames.delete(value);
                }
            });
            applyFilters();
        };

        // Apply filters
        function applyFilters() {
            filteredCpus = allCpus.filter(cpu => {
                const familyMatch = activeFamilies.size === 0 || !cpu.family || activeFamilies.has(cpu.family);
                const codenameMatch = activeCodenames.size === 0 || !cpu.codename || activeCodenames.has(cpu.codename);
                return familyMatch && codenameMatch;
            });
            updateStats();
            updateChart();
        }

        // Update chart
        function updateChart() {
            const xAxis = document.getElementById('xAxis').value;
            const yAxis = document.getElementById('yAxis').value;
            const chartType = document.getElementById('chartType').value;

            const xLabel = document.getElementById('xAxis').options[document.getElementById('xAxis').selectedIndex].text;
            const yLabel = document.getElementById('yAxis').options[document.getElementById('yAxis').selectedIndex].text;

            document.getElementById('chartTitle').textContent = `${yLabel} vs ${xLabel}`;

            // Filter out CPUs with missing data
            const validCpus = filteredCpus.filter(cpu => 
                cpu[xAxis] != null && cpu[yAxis] != null
            );

            if (validCpus.length === 0) {
                document.getElementById('chart').innerHTML = 
                    '<div class="error">No data available for selected parameters</div>';
                document.getElementById('downloadChart').classList.add('hidden');
                return;
            }
            
            // Show download button when we have valid data
            const downloadBtn = document.getElementById('downloadChart');
            if (downloadBtn) {
                downloadBtn.classList.remove('hidden');
            }

            let traces = [];
            let layout = {};

            if (chartType === 'scatter') {
                // Colorblind-friendly color palette (Okabe-Ito inspired)
                const colorPalette = [
                    '#0072B2', // Blue
                    '#E69F00', // Orange
                    '#009E73', // Bluish Green
                    '#D55E00', // Vermillion
                    '#CC79A7', // Reddish Purple
                    '#56B4E9', // Sky Blue
                    '#F0E442', // Yellow
                    '#000000'  // Black
                ];
                
                // Group by family for color coding
                const families = [...new Set(validCpus.map(cpu => cpu.family || 'Unknown'))];
                families.forEach((family, index) => {
                    const familyCpus = validCpus.filter(cpu => (cpu.family || 'Unknown') === family);
                    traces.push({
                        x: familyCpus.map(cpu => cpu[xAxis]),
                        y: familyCpus.map(cpu => cpu[yAxis]),
                        mode: 'markers',
                        type: 'scatter',
                        name: family,
                        text: familyCpus.map(cpu => cpu.cpu_model_name),
                        hovertemplate: '<b>%{text}</b><br>' + 
                                      xLabel + ': %{x}<br>' + 
                                      yLabel + ': %{y}<extra></extra>',
                        marker: {
                            size: 14,
                            opacity: 0.8,
                            color: colorPalette[index % colorPalette.length],
                            line: {
                                width: 1.5,
                                color: '#ffffff'
                            }
                        }
                    });
                });

                // Detect mobile screen size
                const isMobile = window.innerWidth <= 768;
                
                layout = {
                    title: {
                        text: `${yLabel} vs ${xLabel}`,
                        font: { size: isMobile ? 14 : 18 }
                    },
                    xaxis: { 
                        title: xLabel,
                        titlefont: { size: isMobile ? 12 : 14 }
                    },
                    yaxis: { 
                        title: yLabel,
                        titlefont: { size: isMobile ? 12 : 14 }
                    },
                    hovermode: 'closest',
                    margin: isMobile 
                        ? { l: 50, r: 10, t: 50, b: 100 }
                        : { l: 60, r: 20, t: 60, b: 60 },
                    showlegend: true,
                    legend: isMobile ? {
                        x: 0.5,
                        y: -0.25,
                        xanchor: 'center',
                        yanchor: 'top',
                        orientation: 'h',
                        bgcolor: 'rgba(255, 255, 255, 0.9)',
                        bordercolor: '#e2e8f0',
                        borderwidth: 1,
                        font: { size: 10 },
                        itemwidth: 20
                    } : {
                        x: 1.02,
                        y: 1,
                        xanchor: 'left',
                        yanchor: 'top',
                        bgcolor: 'rgba(255, 255, 255, 0.8)',
                        bordercolor: '#e2e8f0',
                        borderwidth: 1
                    }
                };
            } else if (chartType === 'bar') {
                // Get limit from input (default 25)
                const barLimit = parseInt(document.getElementById('barLimit').value) || 25;
                
                // Sort by y-axis value and take top N for readability
                const sorted = [...validCpus].sort((a, b) => (b[yAxis] || 0) - (a[yAxis] || 0)).slice(0, barLimit);
                
                // Calculate dynamic height based on number of CPUs
                // Base height: 600px for up to 25 CPUs
                // For 25-50: 30px per CPU
                // For 50+: 25px per CPU (more compact but still readable)
                let chartHeight;
                const numCpus = sorted.length;
                if (numCpus <= 25) {
                    chartHeight = 600;
                } else if (numCpus <= 50) {
                    chartHeight = 600 + (numCpus - 25) * 30;
                } else {
                    chartHeight = 600 + 25 * 30 + (numCpus - 50) * 25;
                }
                
                // Set chart container height dynamically
                const chartElement = document.getElementById('chart');
                chartElement.style.height = chartHeight + 'px';
                chartElement.style.minHeight = chartHeight + 'px';
                
                // Group by family for legend
                const families = [...new Set(sorted.map(cpu => {
                    if (!cpu.family) return 'Unknown';
                    if (cpu.family.includes('EPYC')) return 'AMD EPYC';
                    if (cpu.family.includes('Xeon')) return 'Intel Xeon';
                    return cpu.family;
                }))];
                
                // Colorblind-friendly color mapping
                const familyColors = {
                    'AMD EPYC': '#0072B2',  // Blue
                    'Intel Xeon': '#E69F00', // Orange
                    'Unknown': '#7f7f7f'     // Gray
                };
                
                const getColorForFamily = (family) => {
                    if (!family) return familyColors['Unknown'];
                    if (family.includes('EPYC')) return familyColors['AMD EPYC'];
                    if (family.includes('Xeon')) return familyColors['Intel Xeon'];
                    return '#009E73'; // Green for others
                };
                
                // Create separate traces for each family to enable legend
                families.forEach(family => {
                    const familyCpus = sorted.filter(cpu => {
                        if (family === 'Unknown') return !cpu.family;
                        if (family === 'AMD EPYC') return cpu.family && cpu.family.includes('EPYC');
                        if (family === 'Intel Xeon') return cpu.family && cpu.family.includes('Xeon');
                        return cpu.family === family;
                    });
                    
                    if (familyCpus.length > 0) {
                        traces.push({
                            x: familyCpus.map(cpu => cpu[yAxis]),
                            y: familyCpus.map(cpu => cpu.cpu_model_name),
                            type: 'bar',
                            orientation: 'h',
                            name: family,
                            marker: {
                                color: familyColors[family] || getColorForFamily(familyCpus[0].family),
                                line: {
                                    width: 1,
                                    color: '#ffffff'
                                }
                            },
                            text: familyCpus.map(cpu => `${xLabel}: ${cpu[xAxis]}`),
                            hovertemplate: '<b>%{y}</b><br>' + 
                                          yLabel + ': %{x}<br>' + 
                                          '%{text}<extra></extra>'
                        });
                    }
                });

                // Detect mobile screen size
                const isMobile = window.innerWidth <= 768;
                
                layout = {
                    title: {
                        text: `Top ${sorted.length} CPUs by ${yLabel}`,
                        font: { size: isMobile ? 14 : 18 }
                    },
                    xaxis: { 
                        title: yLabel,
                        titlefont: { size: isMobile ? 12 : 14 }
                    },
                    yaxis: { 
                        title: 'CPU Model',
                        automargin: true,
                        tickmode: 'linear',
                        tickangle: 0,
                        titlefont: { size: isMobile ? 12 : 14 }
                    },
                    margin: isMobile 
                        ? { l: 180, r: 20, t: 50, b: 100 }
                        : { l: 250, r: 150, t: 60, b: 60 },
                    showlegend: true,
                    legend: isMobile ? {
                        x: 0.5,
                        y: -0.25,
                        xanchor: 'center',
                        yanchor: 'top',
                        orientation: 'h',
                        bgcolor: 'rgba(255, 255, 255, 0.9)',
                        bordercolor: '#e2e8f0',
                        borderwidth: 1,
                        font: { size: 10 },
                        itemwidth: 20
                    } : {
                        x: 1.02,
                        y: 1,
                        xanchor: 'left',
                        yanchor: 'top',
                        bgcolor: 'rgba(255, 255, 255, 0.8)',
                        bordercolor: '#e2e8f0',
                        borderwidth: 1
                    },
                    height: chartHeight
                };
            } else if (chartType === 'box') {
                // Colorblind-friendly color palette (more vibrant, less pastel)
                const colorPalette = [
                    '#0072B2', // Blue
                    '#E69F00', // Orange
                    '#009E73', // Bluish Green
                    '#D55E00', // Vermillion
                    '#CC79A7', // Reddish Purple
                    '#56B4E9', // Sky Blue
                    '#F0E442', // Yellow
                    '#000000'  // Black
                ];
                
                // Group by family for box plots
                const families = [...new Set(validCpus.map(cpu => cpu.family || 'Unknown'))];
                families.forEach((family, index) => {
                    const familyCpus = validCpus.filter(cpu => (cpu.family || 'Unknown') === family);
                    const color = colorPalette[index % colorPalette.length];
                    traces.push({
                        y: familyCpus.map(cpu => cpu[yAxis]),
                        type: 'box',
                        name: family,
                        boxpoints: 'all',
                        jitter: 0.3,
                        pointpos: -1.8,
                        text: familyCpus.map(cpu => cpu.cpu_model_name || 'Unknown CPU'),
                        hovertemplate: '<b>%{text}</b><br>' +
                                      'Family: ' + family + '<br>' +
                                      yLabel + ': %{y}<br>' +
                                      '<extra></extra>',
                        marker: {
                            size: 8,
                            opacity: 0.8,
                            color: color,
                            line: {
                                width: 1,
                                color: '#ffffff'
                            }
                        },
                        line: {
                            color: color,
                            width: 2.5
                        },
                        fillcolor: color,
                        opacity: 0.6
                    });
                });

                // Detect mobile screen size
                const isMobile = window.innerWidth <= 768;
                
                layout = {
                    title: {
                        text: `Distribution of ${yLabel} by Family`,
                        font: { size: isMobile ? 14 : 18 }
                    },
                    yaxis: { 
                        title: yLabel,
                        titlefont: { size: isMobile ? 12 : 14 }
                    },
                    xaxis: { 
                        title: 'Family',
                        tickangle: 0,
                        titlefont: { size: isMobile ? 12 : 14 }
                    },
                    margin: isMobile 
                        ? { l: 50, r: 10, t: 50, b: 150 }
                        : { l: 60, r: 20, t: 60, b: 100 },
                    showlegend: true,
                    legend: isMobile ? {
                        x: 0.5,
                        y: -0.25,
                        xanchor: 'center',
                        yanchor: 'top',
                        orientation: 'h',
                        bgcolor: 'rgba(255, 255, 255, 0.9)',
                        bordercolor: '#e2e8f0',
                        borderwidth: 1,
                        font: { size: 10 },
                        itemwidth: 20
                    } : {
                        x: 1.02,
                        y: 1,
                        xanchor: 'left',
                        yanchor: 'top',
                        bgcolor: 'rgba(255, 255, 255, 0.8)',
                        bordercolor: '#e2e8f0',
                        borderwidth: 1
                    }
                };
            }

            // No need for updateLayoutForMobile - layout is already set correctly above
            // Detect mobile for modebar
            const isMobile = window.innerWidth <= 768;
            
            Plotly.newPlot('chart', traces, layout, { 
                responsive: true,
                displayModeBar: !isMobile, // Hide modebar on mobile
                modeBarButtonsToRemove: ['lasso2d', 'select2d'],
                displaylogo: false
            });
            
            // Update chart on window resize for mobile
            let resizeTimeout;
            let resizeHandler = () => {
                clearTimeout(resizeTimeout);
                resizeTimeout = setTimeout(() => {
                    const chartElement = document.getElementById('chart');
                    if (chartElement && chartElement.children.length > 0) {
                        Plotly.Plots.resize('chart');
                    }
                }, 250);
            };
            
            // Only add resize listener once
            if (!window.chartResizeHandlerAdded) {
                window.addEventListener('resize', resizeHandler);
                window.chartResizeHandlerAdded = true;
            }
        }

        // Download chart function
        function downloadChart() {
            const xAxis = document.getElementById('xAxis').value;
            const yAxis = document.getElementById('yAxis').value;
            const chartType = document.getElementById('chartType').value;
            
            const xLabel = document.getElementById('xAxis').options[document.getElementById('xAxis').selectedIndex].text;
            const yLabel = document.getElementById('yAxis').options[document.getElementById('yAxis').selectedIndex].text;
            
            // Create descriptive filename
            const chartTypeName = chartType === 'bar' ? 'Bar' : chartType === 'scatter' ? 'Scatter' : 'Box';
            const filename = `CPU_${chartTypeName}_${yLabel.replace(/[^a-zA-Z0-9]/g, '_')}_vs_${xLabel.replace(/[^a-zA-Z0-9]/g, '_')}_${new Date().toISOString().split('T')[0]}.png`;
            
            // Download the chart
            Plotly.downloadImage('chart', {
                format: 'png',
                width: 1200,
                height: 800,
                filename: filename
            });
        }

        // Download button event listeners
        document.getElementById('downloadChart').addEventListener('click', downloadChart);
        document.getElementById('downloadComparison').addEventListener('click', downloadComparisonTable);

        // CPU Comparison Functions
        function populateComparisonDropdowns() {
            const cpu1Select = document.getElementById('cpu1Select');
            const cpu2Select = document.getElementById('cpu2Select');
            
            // Clear existing options (except first)
            cpu1Select.innerHTML = '<option value="">Select CPU...</option>';
            cpu2Select.innerHTML = '<option value="">Select CPU...</option>';
            
            // Sort CPUs by name for easier selection
            const sortedCpus = [...allCpus].sort((a, b) => 
                (a.cpu_model_name || '').localeCompare(b.cpu_model_name || '')
            );
            
            sortedCpus.forEach(cpu => {
                const option1 = document.createElement('option');
                option1.value = cpu.id;
                option1.textContent = `${cpu.cpu_model_name}${cpu.codename ? ' (' + cpu.codename + ')' : ''}`;
                cpu1Select.appendChild(option1);
                
                const option2 = document.createElement('option');
                option2.value = cpu.id;
                option2.textContent = `${cpu.cpu_model_name}${cpu.codename ? ' (' + cpu.codename + ')' : ''}`;
                cpu2Select.appendChild(option2);
            });
        }

        function compareCPUs() {
            const cpu1Id = parseInt(document.getElementById('cpu1Select').value);
            const cpu2Id = parseInt(document.getElementById('cpu2Select').value);
            
            if (!cpu1Id || !cpu2Id) {
                alert('Please select both CPUs to compare');
                return;
            }
            
            if (cpu1Id === cpu2Id) {
                alert('Please select two different CPUs to compare');
                return;
            }
            
            const cpu1 = allCpus.find(c => c.id === cpu1Id);
            const cpu2 = allCpus.find(c => c.id === cpu2Id);
            
            if (!cpu1 || !cpu2) {
                alert('CPU not found');
                return;
            }
            
            displayComparison(cpu1, cpu2);
        }

        function displayComparison(cpu1, cpu2) {
            const cpu1Name = cpu1.cpu_model_name || 'CPU 1';
            const cpu2Name = cpu2.cpu_model_name || 'CPU 2';
            
            document.getElementById('cpu1NameHeader').textContent = cpu1Name;
            document.getElementById('cpu2NameHeader').textContent = cpu2Name;
            
            const comparisonBody = document.getElementById('comparisonBody');
            comparisonBody.innerHTML = '';
            
            const parameters = [
                { key: 'cpu_model_name', label: 'CPU Model Name', type: 'text' },
                { key: 'codename', label: 'Codename', type: 'text' },
                { key: 'family', label: 'Family', type: 'text' },
                { key: 'cpu_model', label: 'CPU Model', type: 'text' },
                { key: 'cores', label: 'Cores', type: 'number', higher: 'better', format: (v) => v != null ? v : '-' },
                { key: 'threads', label: 'Threads', type: 'number', higher: 'better', format: (v) => v != null ? v : '-' },
                { key: 'max_turbo_frequency_ghz', label: 'Max Turbo Frequency', type: 'number', higher: 'better', unit: 'GHz', format: (v) => v ? v.toFixed(2) : '-' },
                { key: 'l3_cache_mb', label: 'L3 Cache', type: 'number', higher: 'better', unit: 'MB', format: (v) => v ? v.toFixed(1) : '-' },
                { key: 'tdp_watts', label: 'TDP', type: 'number', higher: 'worse', unit: 'W', format: (v) => v || '-' },
                { key: 'launch_year', label: 'Launch Year', type: 'number', higher: 'better', format: (v) => v || '-' },
                { key: 'max_memory_tb', label: 'Max Memory', type: 'number', higher: 'better', unit: 'TB', format: (v) => v ? v.toFixed(2) : '-' }
            ];
            
            parameters.forEach((param, index) => {
                const row = document.createElement('tr');
                const val1 = cpu1[param.key];
                const val2 = cpu2[param.key];
                
                const rowClass = index % 2 === 0 ? 'row-odd' : 'row-even';
                
                let diffHtml = '';
                let cell1Highlight = '';
                let cell2Highlight = '';
                
                if (param.type === 'number' && val1 != null && val2 != null && param.higher) {
                    const diff = val2 - val1;
                    const percentDiff = val1 !== 0 ? ((diff / val1) * 100).toFixed(1) : 0;
                    // Round diff to 2 decimal places to avoid floating point precision issues
                    const diffRounded = Math.abs(diff).toFixed(2);
                    // Remove trailing zeros for cleaner display
                    const diffFormatted = parseFloat(diffRounded).toString();
                    
                    if (diff > 0) {
                        const badgeClass = param.higher === 'better' ? 'diff-better' : 'diff-worse';
                        cell2Highlight = param.higher === 'better' ? 'highlight-better' : 'highlight-worse';
                        diffHtml = `<span class="comparison-diff-badge ${badgeClass}">+${diffFormatted}${param.unit ? ' ' + param.unit : ''} (+${Math.abs(percentDiff)}%)</span>`;
                    } else if (diff < 0) {
                        const badgeClass = param.higher === 'better' ? 'diff-worse' : 'diff-better';
                        cell1Highlight = param.higher === 'better' ? 'highlight-worse' : 'highlight-better';
                        diffHtml = `<span class="comparison-diff-badge ${badgeClass}">-${diffFormatted}${param.unit ? ' ' + param.unit : ''} (${percentDiff}%)</span>`;
                    } else {
                        diffHtml = '<span class="comparison-diff-badge diff-same">Same</span>';
                    }
                } else if (param.type === 'text') {
                    diffHtml = val1 === val2
                        ? '<span class="comparison-diff-badge diff-same">Same</span>'
                        : '<span class="comparison-diff-badge diff-different">Different</span>';
                } else {
                    diffHtml = val1 === val2
                        ? '<span class="comparison-diff-badge diff-same">Same</span>'
                        : '<span class="comparison-diff-badge diff-different">Different</span>';
                }
                
                const formatValue = param.format || ((v) => v != null ? v : '-');
                const display1 = formatValue(val1);
                const display2 = formatValue(val2);
                const unit1 = (param.unit && display1 !== '-') ? ` ${param.unit}` : '';
                const unit2 = (param.unit && display2 !== '-') ? ` ${param.unit}` : '';
                
                row.innerHTML = `
                    <td class="comparison-label-cell ${rowClass}">${param.label}</td>
                    <td class="comparison-value-cell ${cell1Highlight} ${rowClass}"><span class="comparison-value">${display1}${unit1}</span></td>
                    <td class="comparison-value-cell ${cell2Highlight} ${rowClass}"><span class="comparison-value">${display2}${unit2}</span></td>
                    <td class="comparison-value-cell ${rowClass}">${diffHtml}</td>
                `;
                comparisonBody.appendChild(row);
            });
            
            // Store CPU data for download
            window.currentComparison = { cpu1, cpu2, parameters };
            
            document.getElementById('comparisonResult').classList.remove('hidden');
        }

        // Download comparison table as CSV
        function downloadComparisonTable() {
            if (!window.currentComparison) return;
            
            const { cpu1, cpu2, parameters } = window.currentComparison;
            const cpu1Name = cpu1.cpu_model_name || 'CPU 1';
            const cpu2Name = cpu2.cpu_model_name || 'CPU 2';
            
            // Escape function for CSV values
            const escapeCSV = (str) => {
                if (str === null || str === undefined) return '';
                const s = String(str);
                // Always wrap in quotes and escape internal quotes for proper CSV format
                return '"' + s.replace(/"/g, '""') + '"';
            };
            
            // Create CSV content with properly escaped header
            let csv = escapeCSV('Specification') + ',' + 
                      escapeCSV(cpu1Name) + ',' + 
                      escapeCSV(cpu2Name) + ',' + 
                      escapeCSV('Difference') + '\n';
            
            parameters.forEach(param => {
                const val1 = cpu1[param.key];
                const val2 = cpu2[param.key];
                
                const formatValue = param.format || ((v) => v != null ? v : '-');
                const display1 = formatValue(val1);
                const display2 = formatValue(val2);
                const unit1 = (param.unit && display1 !== '-') ? ` ${param.unit}` : '';
                const unit2 = (param.unit && display2 !== '-') ? ` ${param.unit}` : '';
                
                let diff = '';
                if (param.type === 'number' && val1 != null && val2 != null && param.higher) {
                    const diffValue = val2 - val1;
                    const percentDiff = val1 !== 0 ? ((diffValue / val1) * 100).toFixed(1) : 0;
                    const diffRounded = Math.abs(diffValue).toFixed(2);
                    const diffFormatted = parseFloat(diffRounded).toString();
                    
                    if (diffValue > 0) {
                        diff = `+${diffFormatted}${param.unit ? ' ' + param.unit : ''} (+${Math.abs(percentDiff)}%)`;
                    } else if (diffValue < 0) {
                        diff = `-${diffFormatted}${param.unit ? ' ' + param.unit : ''} (${percentDiff}%)`;
                    } else {
                        diff = 'Same';
                    }
                } else if (param.type === 'text') {
                    diff = val1 === val2 ? 'Same' : 'Different';
                } else {
                    diff = val1 === val2 ? 'Same' : 'Different';
                }
                
                csv += escapeCSV(param.label) + ',' + 
                       escapeCSV(display1 + unit1) + ',' + 
                       escapeCSV(display2 + unit2) + ',' + 
                       escapeCSV(diff) + '\n';
            });
            
            // Create download link
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            
            // Create filename with CPU names and date
            const dateStr = new Date().toISOString().split('T')[0];
            const filename = `CPU_Comparison_${cpu1Name.replace(/[^a-zA-Z0-9]/g, '_')}_vs_${cpu2Name.replace(/[^a-zA-Z0-9]/g, '_')}_${dateStr}.csv`;
            link.setAttribute('download', filename);
            
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Event listeners
        document.getElementById('xAxis').addEventListener('change', updateChart);
        document.getElementById('yAxis').addEventListener('change', updateChart);
        document.getElementById('chartType').addEventListener('change', function() {
            const barLimitGroup = document.getElementById('barLimitGroup');
            if (this.value === 'bar') {
                barLimitGroup.classList.remove('hidden');
            } else {
                barLimitGroup.classList.add('hidden');
            }
            updateChart();
        });
        document.getElementById('barLimit').addEventListener('change', updateChart);
        document.getElementById('barLimit').addEventListener('input', updateChart);
        
        document.getElementById('cpu1Select').addEventListener('change', function() {
            const cpu1 = this.value;
            const cpu2 = document.getElementById('cpu2Select').value;
            document.getElementById('compareButton').disabled = !cpu1 || !cpu2;
        });

        document.getElementById('cpu2Select').addEventListener('change', function() {
            const cpu1 = document.getElementById('cpu1Select').value;
            const cpu2 = this.value;
            document.getElementById('compareButton').disabled = !cpu1 || !cpu2;
        });
        
        document.getElementById('compareButton').addEventListener('click', compareCPUs);

        // Initialize
        loadData();
    </script>
</body>
</html>

